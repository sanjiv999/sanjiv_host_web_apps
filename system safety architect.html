<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Safety Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f8fafc; overflow: hidden; user-select: none; }
        .canvas-grid {
            background-size: 40px 40px;
            background-image:
                linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .node-base { transition: box-shadow 0.2s, border-color 0.2s; }
        .node-selected { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); z-index: 50 !important; border-color: #3b82f6 !important; ring: 2px solid #bfdbfe; }
    </style>
</head>
<body>

    <!-- APP CONTAINER -->
    <div id="app" class="w-screen h-screen flex flex-col overflow-hidden text-slate-800">
        
        <!-- TOOLBAR -->
        <div class="h-14 bg-white border-b border-slate-200 flex items-center px-4 justify-between z-20 shadow-sm shrink-0">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">SA</div>
                <h1 class="font-semibold text-lg hidden sm:block">System Safety Architect</h1>
            </div>
            
            <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                <button onclick="app.addNode()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-white hover:shadow-sm text-sm font-medium transition-all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg> 
                    Add Node
                </button>
                <button id="btn-link-mode" onclick="app.toggleLinkMode()" class="flex items-center gap-1 px-3 py-1.5 rounded text-sm font-medium transition-all hover:bg-white hover:shadow-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    Link Nodes
                </button>
                <button onclick="app.exportData()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-white hover:shadow-sm text-sm font-medium transition-all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export
                </button>
            </div>
        </div>

        <!-- WORKSPACE -->
        <div class="flex-1 relative flex overflow-hidden">
            
            <!-- CANVAS AREA -->
            <div id="canvas-container" class="flex-1 relative cursor-grab active:cursor-grabbing canvas-grid overflow-hidden">
                <!-- PANNING LAYER -->
                <div id="pan-layer" class="absolute top-0 left-0 w-full h-full transform origin-top-left will-change-transform" style="transform: translate(0px, 0px);">
                    
                    <!-- LINKS LAYER (SVG) -->
                    <svg id="svg-layer" class="absolute top-0 left-0 overflow-visible pointer-events-none" width="4000" height="4000">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                            </marker>
                            <marker id="arrowhead-selected" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#2563eb" />
                            </marker>
                        </defs>
                        <!-- Paths injected by JS -->
                    </svg>

                    <!-- TIER LABELS -->
                    <div class="absolute -left-20 top-20 text-4xl font-black text-slate-200 select-none pointer-events-none -rotate-90 origin-right">TIER 5</div>
                    <div class="absolute -left-20 top-80 text-4xl font-black text-slate-200 select-none pointer-events-none -rotate-90 origin-right">TIER 4</div>
                    <div class="absolute -left-20 top-[450px] text-4xl font-black text-slate-200 select-none pointer-events-none -rotate-90 origin-right">TIER 3</div>
                    <div class="absolute -left-20 top-[600px] text-4xl font-black text-slate-200 select-none pointer-events-none -rotate-90 origin-right">TIER 2</div>
                    <div class="absolute -left-20 top-[750px] text-4xl font-black text-slate-200 select-none pointer-events-none -rotate-90 origin-right">TIER 1</div>

                    <!-- NODES LAYER -->
                    <div id="nodes-layer" class="absolute top-0 left-0 w-full h-full">
                        <!-- Nodes injected by JS -->
                    </div>

                </div>
            </div>

            <!-- PROPERTIES PANEL -->
            <div id="properties-panel" class="hidden w-80 bg-white border-l border-slate-200 shadow-xl p-4 flex flex-col gap-4 z-30 overflow-y-auto">
                <div class="flex justify-between items-center pb-2 border-b border-slate-100">
                    <h2 id="prop-title" class="font-bold text-slate-700">Edit</h2>
                    <button onclick="app.deselectAll()" class="text-slate-400 hover:text-slate-600">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="M6 6 18 18"/></svg>
                    </button>
                </div>
                <div id="prop-content" class="flex flex-col gap-4">
                    <!-- Injected by JS -->
                </div>
                <div class="mt-auto pt-4 border-t border-slate-100">
                    <button onclick="app.deleteSelected()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-600 rounded hover:bg-red-100 transition-colors text-sm font-semibold">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                        Delete Item
                    </button>
                </div>
            </div>

        </div>

        <!-- LEGEND -->
        <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur border border-slate-200 p-3 rounded-lg shadow-lg text-xs z-20 pointer-events-none">
            <h3 class="font-bold mb-2">Evidence Key</h3>
            <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-1 bg-blue-600" style="height: 5px"></div>
                    <span>5/5: Causal/Strong</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-1 bg-blue-600" style="height: 3px"></div>
                    <span>3/5: Mixed/Contextual</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-1 bg-blue-600" style="height: 1px"></div>
                    <span>1/5: Weak/Theoretical</span>
                </div>
            </div>
        </div>

    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        class SafetyApp {
            constructor() {
                // --- Initial Data ---
                this.nodes = [
                    { id: 'n1', type: 'tier5', label: 'Financial Incentives', x: 100, y: 80, evidence: 2, desc: 'Vol vs Value (Payment Trap)' },
                    { id: 'n2', type: 'tier5', label: 'Governance & Regs', x: 350, y: 80, evidence: 3, desc: 'Regulatory Cacophony' },
                    { id: 'n3', type: 'tier5', label: 'Measurement/Reputation', x: 600, y: 80, evidence: 2, desc: 'Market Signal' },
                    { id: 'n4', type: 'tier5', label: 'Legal Environment', x: 850, y: 80, evidence: 4, desc: 'Liability Freeze' },
                    { id: 'n5', type: 'tier4', label: 'Board of Directors', x: 200, y: 250, evidence: 4, desc: 'Risk Appetite' },
                    { id: 'n6', type: 'tier4', label: 'Exec Leadership', x: 450, y: 250, evidence: 3, desc: 'Translation Engine' },
                    { id: 'n7', type: 'tier4', label: 'Resource Allocation', x: 700, y: 250, evidence: 5, desc: 'Slack vs Efficiency' },
                    { id: 'n8', type: 'tier3', label: 'Safety Culture', x: 250, y: 400, evidence: 3, desc: 'Psychological Safety' },
                    { id: 'n9', type: 'tier3', label: 'Physical Env & Staffing', x: 500, y: 400, evidence: 5, desc: 'Crowding/Ratios' },
                    { id: 'n10', type: 'tier3', label: 'Human-System Interface', x: 750, y: 400, evidence: 4, desc: 'Tech/Usability' },
                    { id: 'n11', type: 'tier2', label: 'Complexity vs Capacity', x: 500, y: 550, evidence: 0, desc: 'Friction Point' },
                    { id: 'n12', type: 'tier1', label: 'Cognitive Load', x: 400, y: 700, evidence: 5, desc: 'Fatigue/Burnout' },
                    { id: 'n13', type: 'tier1', label: 'The Patient', x: 650, y: 700, evidence: 0, desc: 'Keystone' }
                ];

                this.links = [
                    { id: 'l1', source: 'n1', target: 'n7', evidence: 5, label: 'Budget Constraints' },
                    { id: 'l2', source: 'n2', target: 'n6', evidence: 3, label: 'Mandates' },
                    { id: 'l3', source: 'n4', target: 'n6', evidence: 4, label: 'Fear of Liability' },
                    { id: 'l4', source: 'n5', target: 'n7', evidence: 4, label: 'Approval' },
                    { id: 'l5', source: 'n6', target: 'n7', evidence: 5, label: 'Strategy' },
                    { id: 'l6', source: 'n6', target: 'n8', evidence: 3, label: 'Modeling' },
                    { id: 'l7', source: 'n7', target: 'n9', evidence: 5, label: 'FTE Counts' },
                    { id: 'l8', source: 'n7', target: 'n10', evidence: 4, label: 'IT Budget' },
                    { id: 'l9', source: 'n9', target: 'n11', evidence: 5, label: 'Capacity Constraint' },
                    { id: 'l10', source: 'n10', target: 'n11', evidence: 4, label: 'Workflow Friction' },
                    { id: 'l11', source: 'n11', target: 'n12', evidence: 5, label: 'Overload' },
                    { id: 'l12', source: 'n12', target: 'n13', evidence: 0, label: 'Adverse Event' }
                ];

                // --- State ---
                this.pan = { x: 0, y: 0 };
                this.isPanning = false;
                this.panStart = { x: 0, y: 0 };
                
                this.selection = null; // { type: 'node'|'link', id: string }
                this.draggingNodeId = null;
                this.dragOffset = { x: 0, y: 0 };

                this.isLinkingMode = false;
                this.tempLinkSourceId = null;
                this.mousePos = { x: 0, y: 0 };

                // --- Configuration ---
                this.TIER_STYLES = {
                    tier5: { bg: 'bg-slate-100', border: 'border-slate-400', text: 'text-slate-800', badge: 'bg-slate-600' },
                    tier4: { bg: 'bg-blue-50', border: 'border-blue-400', text: 'text-blue-800', badge: 'bg-blue-600' },
                    tier3: { bg: 'bg-orange-50', border: 'border-orange-400', text: 'text-orange-800', badge: 'bg-orange-600' },
                    tier2: { bg: 'bg-yellow-50', border: 'border-yellow-400', text: 'text-yellow-800', badge: 'bg-yellow-600' },
                    tier1: { bg: 'bg-red-50', border: 'border-red-400', text: 'text-red-800', badge: 'bg-red-600' }
                };

                // --- DOM Elements ---
                this.elPanLayer = document.getElementById('pan-layer');
                this.elSvgLayer = document.getElementById('svg-layer');
                this.elNodesLayer = document.getElementById('nodes-layer');
                this.elCanvasContainer = document.getElementById('canvas-container');
                this.elPropPanel = document.getElementById('properties-panel');
                this.elPropContent = document.getElementById('prop-content');
                this.elPropTitle = document.getElementById('prop-title');
                this.elBtnLinkMode = document.getElementById('btn-link-mode');

                this.init();
            }

            init() {
                this.renderAll();
                this.setupEventListeners();
            }

            // --- Rendering ---
            
            renderAll() {
                this.renderNodes();
                this.renderLinks();
                this.updatePanZoom();
                this.renderProperties();
                this.updateUIButtons();
            }

            renderNodes() {
                this.elNodesLayer.innerHTML = '';
                this.nodes.forEach(node => {
                    const styles = this.TIER_STYLES[node.type] || this.TIER_STYLES.tier3;
                    const isSelected = this.selection && this.selection.id === node.id;
                    const isSource = this.tempLinkSourceId === node.id;
                    
                    const div = document.createElement('div');
                    div.className = `absolute w-52 rounded-lg border-2 p-3 flex flex-col gap-1 pointer-events-auto cursor-grab active:cursor-grabbing node-base group
                        ${styles.bg} ${styles.border} ${isSelected || isSource ? 'node-selected' : 'shadow-md hover:shadow-lg z-10'}`;
                    div.style.left = `${node.x}px`;
                    div.style.top = `${node.y}px`;
                    div.dataset.id = node.id;
                    
                    // Stars HTML
                    let starsHtml = '';
                    for(let i=1; i<=5; i++) {
                        starsHtml += `<div class="w-1.5 h-1.5 rounded-full ${i <= node.evidence ? 'bg-yellow-500' : 'bg-gray-200'}"></div>`;
                    }

                    div.innerHTML = `
                        <div class="flex justify-between items-start pointer-events-none">
                            <span class="text-[10px] font-bold uppercase tracking-wider px-1.5 py-0.5 rounded text-white ${styles.badge}">
                                ${node.type}
                            </span>
                            <div class="flex gap-0.5">${starsHtml}</div>
                        </div>
                        <div class="font-bold leading-tight ${styles.text} pointer-events-none select-none">${node.label}</div>
                        ${node.desc ? `<div class="text-xs text-slate-500 italic mt-1 border-t border-slate-200/50 pt-1 pointer-events-none select-none">${node.desc}</div>` : ''}
                    `;

                    // Mouse Events on Node
                    div.addEventListener('mousedown', (e) => this.handleNodeMouseDown(e, node.id));
                    
                    this.elNodesLayer.appendChild(div);
                });
            }

            renderLinks() {
                // Keep definitions, clear paths
                const defs = this.elSvgLayer.querySelector('defs').outerHTML;
                let svgContent = defs;

                this.links.forEach(link => {
                    const isSelected = this.selection && this.selection.id === link.id;
                    const strokeWidth = Math.max(2, link.evidence);
                    const strokeColor = isSelected ? '#2563eb' : '#94a3b8';
                    const marker = isSelected ? 'url(#arrowhead-selected)' : 'url(#arrowhead)';
                    
                    const pathD = this.getLinkPath(link.source, link.target);
                    
                    // Label Badge Position
                    const s = this.getNodeCenter(link.source);
                    const t = this.getNodeCenter(link.target);
                    const mx = (s.x + t.x) / 2;
                    const my = (s.y + t.y) / 2;
                    
                    // Click Hitbox (invisible thick line)
                    svgContent += `<path d="${pathD}" stroke="transparent" stroke-width="20" fill="none" class="cursor-pointer pointer-events-auto" onclick="app.selectLink(event, '${link.id}')" />`;
                    
                    // Visible Line
                    svgContent += `<path d="${pathD}" stroke="${strokeColor}" stroke-width="${strokeWidth}" fill="none" marker-end="${marker}" class="pointer-events-none transition-all duration-300" />`;
                    
                    // Badge
                    svgContent += `
                        <foreignObject x="${mx - 50}" y="${my - 12}" width="100" height="24" class="pointer-events-none overflow-visible">
                            <div xmlns="http://www.w3.org/1999/xhtml" class="flex justify-center">
                                <span class="text-xs text-center truncate px-1 rounded border shadow-sm ${isSelected ? 'bg-blue-100 border-blue-300' : 'bg-white border-slate-200'} text-slate-600 max-w-[100px]">
                                    ${link.label}
                                </span>
                            </div>
                        </foreignObject>
                    `;
                });

                // Temporary Link Line
                if (this.isLinkingMode && this.tempLinkSourceId) {
                    const start = this.getNodeCenter(this.tempLinkSourceId);
                    const end = { x: this.mousePos.x - this.pan.x, y: this.mousePos.y - this.pan.y };
                    // Simple Curve
                    const dx = Math.abs(end.x - start.x);
                    const dy = Math.abs(end.y - start.y);
                    const controlOffset = Math.max(dy * 0.5, 50);
                    const pathD = `M ${start.x} ${start.y} C ${start.x} ${start.y + controlOffset}, ${end.x} ${end.y - controlOffset}, ${end.x} ${end.y}`;
                    
                    svgContent += `<path d="${pathD}" stroke="#3b82f6" stroke-width="2" stroke-dasharray="5,5" fill="none" />`;
                }

                this.elSvgLayer.innerHTML = svgContent;
            }

            renderProperties() {
                if (!this.selection) {
                    this.elPropPanel.classList.add('hidden');
                    return;
                }
                this.elPropPanel.classList.remove('hidden');

                if (this.selection.type === 'node') {
                    const node = this.nodes.find(n => n.id === this.selection.id);
                    if (!node) return;
                    this.elPropTitle.innerText = 'Edit Concept';
                    this.elPropContent.innerHTML = `
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">Title</label>
                            <input type="text" value="${node.label}" oninput="app.updateNodeProp('label', this.value)" class="w-full mt-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">Description</label>
                            <textarea oninput="app.updateNodeProp('desc', this.value)" class="w-full mt-1 px-3 py-2 border rounded text-sm h-20 focus:ring-2 focus:ring-blue-500 outline-none">${node.desc || ''}</textarea>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">Tier</label>
                            <select onchange="app.updateNodeProp('type', this.value)" class="w-full mt-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="tier5" ${node.type === 'tier5' ? 'selected' : ''}>Tier 5: External Env</option>
                                <option value="tier4" ${node.type === 'tier4' ? 'selected' : ''}>Tier 4: Management</option>
                                <option value="tier3" ${node.type === 'tier3' ? 'selected' : ''}>Tier 3: Latent Env</option>
                                <option value="tier2" ${node.type === 'tier2' ? 'selected' : ''}>Tier 2: Nature of Work</option>
                                <option value="tier1" ${node.type === 'tier1' ? 'selected' : ''}>Tier 1: Human Operator</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase flex justify-between">
                                Evidence Strength <span class="text-blue-600">${node.evidence}/5</span>
                            </label>
                            <input type="range" min="0" max="5" step="1" value="${node.evidence}" oninput="app.updateNodeProp('evidence', parseInt(this.value))" class="w-full mt-2 accent-blue-600">
                        </div>
                    `;
                } else {
                    const link = this.links.find(l => l.id === this.selection.id);
                    if (!link) return;
                    this.elPropTitle.innerText = 'Edit Link';
                    this.elPropContent.innerHTML = `
                         <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">Link Label</label>
                            <input type="text" value="${link.label}" oninput="app.updateLinkProp('label', this.value)" class="w-full mt-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase flex justify-between">
                                Connection Strength <span class="text-blue-600">${link.evidence}/5</span>
                            </label>
                            <input type="range" min="1" max="5" step="1" value="${link.evidence}" oninput="app.updateLinkProp('evidence', parseInt(this.value))" class="w-full mt-2 accent-blue-600">
                        </div>
                    `;
                }
            }

            updateUIButtons() {
                if (this.isLinkingMode) {
                    this.elBtnLinkMode.classList.add('bg-blue-100', 'text-blue-700', 'shadow-inner');
                    this.elBtnLinkMode.classList.remove('hover:bg-white');
                    this.elBtnLinkMode.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Linking...`;
                } else {
                    this.elBtnLinkMode.classList.remove('bg-blue-100', 'text-blue-700', 'shadow-inner');
                    this.elBtnLinkMode.classList.add('hover:bg-white');
                    this.elBtnLinkMode.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Link Nodes`;
                }
            }

            updatePanZoom() {
                this.elPanLayer.style.transform = `translate(${this.pan.x}px, ${this.pan.y}px)`;
            }

            // --- Logic & Events ---

            setupEventListeners() {
                // Canvas Events
                this.elCanvasContainer.addEventListener('mousedown', (e) => {
                    if (e.target === this.elCanvasContainer || e.target.id === 'pan-layer' || e.target.id === 'svg-layer') {
                        this.isPanning = true;
                        this.panStart = { x: e.clientX - this.pan.x, y: e.clientY - this.pan.y };
                        this.deselectAll();
                    }
                });

                window.addEventListener('mousemove', (e) => {
                    this.mousePos = { x: e.clientX, y: e.clientY };

                    if (this.isPanning) {
                        this.pan = { x: e.clientX - this.panStart.x, y: e.clientY - this.panStart.y };
                        this.updatePanZoom();
                    } else if (this.draggingNodeId) {
                        const node = this.nodes.find(n => n.id === this.draggingNodeId);
                        if (node) {
                            node.x = (e.clientX - this.pan.x) - this.dragOffset.x;
                            node.y = (e.clientY - this.pan.y) - this.dragOffset.y;
                            this.renderNodes(); // Could be optimized to just move element
                            this.renderLinks();
                        }
                    } else if (this.isLinkingMode && this.tempLinkSourceId) {
                        this.renderLinks(); // Re-render to update the drag line
                    }
                });

                window.addEventListener('mouseup', () => {
                    this.isPanning = false;
                    this.draggingNodeId = null;
                });
            }

            handleNodeMouseDown(e, nodeId) {
                e.stopPropagation(); // Don't trigger pan
                
                if (this.isLinkingMode) {
                    if (!this.tempLinkSourceId) {
                        this.tempLinkSourceId = nodeId;
                        this.renderNodes(); // Highlight source
                    } else {
                        if (this.tempLinkSourceId !== nodeId) {
                            this.addLink(this.tempLinkSourceId, nodeId);
                        }
                        this.tempLinkSourceId = null;
                        this.isLinkingMode = false;
                        this.renderAll();
                    }
                } else {
                    this.selection = { type: 'node', id: nodeId };
                    this.draggingNodeId = nodeId;
                    
                    const node = this.nodes.find(n => n.id === nodeId);
                    this.dragOffset = { 
                        x: (e.clientX - this.pan.x) - node.x, 
                        y: (e.clientY - this.pan.y) - node.y 
                    };
                    
                    this.renderAll();
                }
            }

            selectLink(e, linkId) {
                e.stopPropagation();
                this.selection = { type: 'link', id: linkId };
                this.renderAll();
            }

            deselectAll() {
                this.selection = null;
                this.renderAll();
            }

            toggleLinkMode() {
                this.isLinkingMode = !this.isLinkingMode;
                this.tempLinkSourceId = null;
                this.renderAll();
            }

            addNode() {
                const id = `n_${Date.now()}`;
                const newNode = {
                    id,
                    type: 'tier3',
                    label: 'New Concept',
                    x: -this.pan.x + 100,
                    y: -this.pan.y + 100,
                    evidence: 0,
                    desc: 'Description'
                };
                this.nodes.push(newNode);
                this.selection = { type: 'node', id };
                this.renderAll();
            }

            addLink(sourceId, targetId) {
                // Check duplicates
                if (this.links.some(l => l.source === sourceId && l.target === targetId)) return;

                const newLink = {
                    id: `l_${Date.now()}`,
                    source: sourceId,
                    target: targetId,
                    label: 'New Link',
                    evidence: 2
                };
                this.links.push(newLink);
                this.selection = { type: 'link', id: newLink.id };
            }

            deleteSelected() {
                if (!this.selection) return;
                
                if (this.selection.type === 'node') {
                    const id = this.selection.id;
                    this.nodes = this.nodes.filter(n => n.id !== id);
                    this.links = this.links.filter(l => l.source !== id && l.target !== id);
                } else {
                    this.links = this.links.filter(l => l.id !== this.selection.id);
                }
                this.selection = null;
                this.renderAll();
            }

            // --- Property Updates ---
            updateNodeProp(prop, value) {
                if (this.selection && this.selection.type === 'node') {
                    const node = this.nodes.find(n => n.id === this.selection.id);
                    if (node) {
                        node[prop] = value;
                        this.renderNodes();
                        this.renderProperties(); // Keep input in sync (e.g. for evidence slider)
                    }
                }
            }

            updateLinkProp(prop, value) {
                if (this.selection && this.selection.type === 'link') {
                    const link = this.links.find(l => l.id === this.selection.id);
                    if (link) {
                        link[prop] = value;
                        this.renderLinks();
                        this.renderProperties();
                    }
                }
            }

            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ nodes: this.nodes, links: this.links }));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "safety_map.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            // --- Helpers ---
            getNodeCenter(nodeId) {
                const node = this.nodes.find(n => n.id === nodeId);
                if (!node) return { x: 0, y: 0 };
                return { x: node.x + 104, y: node.y + 40 }; // Approx center (w208, h varies)
            }

            getLinkPath(sourceId, targetId) {
                const start = this.getNodeCenter(sourceId);
                const end = this.getNodeCenter(targetId);
                const dx = Math.abs(end.x - start.x);
                const dy = Math.abs(end.y - start.y);
                const controlOffset = Math.max(dy * 0.5, 50);
                
                return `M ${start.x} ${start.y} C ${start.x} ${start.y + controlOffset}, ${end.x} ${end.y - controlOffset}, ${end.x} ${end.y}`;
            }
        }

        // Init App
        const app = new SafetyApp();
    </script>
</body>
</html>
