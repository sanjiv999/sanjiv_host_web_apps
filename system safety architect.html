<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Safety Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; background-color: #f8fafc; overflow: hidden; user-select: none; }
        .canvas-grid {
            background-size: 40px 40px;
            background-image:
                linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .node-base { transition: box-shadow 0.2s, border-color 0.2s; }
        .node-selected { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); z-index: 50 !important; border-color: #3b82f6 !important; ring: 2px solid #bfdbfe; }
    </style>
</head>
<body>

    <div id="app" class="w-screen h-screen flex flex-col overflow-hidden text-slate-800">
        
        <div class="h-14 bg-white border-b border-slate-200 flex items-center px-4 justify-between z-20 shadow-sm shrink-0">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">SA</div>
                <h1 class="font-semibold text-lg hidden sm:block">System Safety Architect</h1>
            </div>
            
            <div class="flex items-center gap-2 bg-slate-100 p-1 rounded-lg">
                <button onclick="window.app.addNode()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-white hover:shadow-sm text-sm font-medium transition-all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg> 
                    Add Node
                </button>
                <button id="btn-link-mode" onclick="window.app.toggleLinkMode()" class="flex items-center gap-1 px-3 py-1.5 rounded text-sm font-medium transition-all hover:bg-white hover:shadow-sm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                    Link Nodes
                </button>
                
                <button onclick="document.getElementById('file-input').click()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-white hover:shadow-sm text-sm font-medium transition-all text-slate-700">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Import
                </button>
                <input type="file" id="file-input" class="hidden" accept=".json" onchange="window.app.importData(this)">

                <button onclick="window.app.exportData()" class="flex items-center gap-1 px-3 py-1.5 rounded hover:bg-white hover:shadow-sm text-sm font-medium transition-all">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Export
                </button>
            </div>
        </div>

        <div class="flex-1 relative flex overflow-hidden">
            
            <div id="canvas-container" class="flex-1 relative cursor-grab active:cursor-grabbing canvas-grid overflow-hidden">
                <div id="pan-layer" class="absolute top-0 left-0 w-full h-full transform origin-top-left will-change-transform" style="transform: translate(0px, 0px);">
                    
                    <svg id="svg-layer" class="absolute top-0 left-0 overflow-visible pointer-events-none" width="4000" height="4000">
                        <defs>
                            <marker id="arrowhead-neutral" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8" />
                            </marker>
                            <marker id="arrowhead-positive" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#16a34a" />
                            </marker>
                            <marker id="arrowhead-negative" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#dc2626" />
                            </marker>
                            <marker id="arrowhead-selected" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#2563eb" />
                            </marker>
                        </defs>
                        </svg>

                    <div class="absolute -left-20 top-20 text-4xl font-black text-slate-200 select-none pointer-events-none -rotate-90 origin-right">TIER 5</div>
                    <div class="absolute -left-20 top-80 text-4xl font-black text-slate-200 select-none pointer-events-none -rotate-90 origin-right">TIER 4</div>
                    <div class="absolute -left-20 top-[450px] text-4xl font-black text-slate-200 select-none pointer-events-none -rotate-90 origin-right">TIER 3</div>
                    <div class="absolute -left-20 top-[600px] text-4xl font-black text-slate-200 select-none pointer-events-none -rotate-90 origin-right">TIER 2</div>
                    <div class="absolute -left-20 top-[750px] text-4xl font-black text-slate-200 select-none pointer-events-none -rotate-90 origin-right">TIER 1</div>

                    <div id="nodes-layer" class="absolute top-0 left-0 w-full h-full">
                        </div>

                </div>
            </div>

            <div id="properties-panel" class="hidden w-80 bg-white border-l border-slate-200 shadow-xl p-4 flex flex-col gap-4 z-30 overflow-y-auto">
                <div class="flex justify-between items-center pb-2 border-b border-slate-100">
                    <h2 id="prop-title" class="font-bold text-slate-700">Edit</h2>
                    <button onclick="window.app.deselectAll()" class="text-slate-400 hover:text-slate-600">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="M6 6 18 18"/></svg>
                    </button>
                </div>
                <div id="prop-content" class="flex flex-col gap-4 pb-20">
                    </div>
                </div>

        </div>

        <div class="absolute bottom-4 left-4 bg-white/90 backdrop-blur border border-slate-200 p-3 rounded-lg shadow-lg text-xs z-20 pointer-events-none">
            <h3 class="font-bold mb-2">Evidence Key</h3>
            <div class="flex flex-col gap-1">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-1 bg-blue-600" style="height: 5px"></div>
                    <span>5/5: Causal/Strong</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-1 bg-blue-600" style="height: 3px"></div>
                    <span>3/5: Mixed/Contextual</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-1 bg-blue-600" style="height: 1px"></div>
                    <span>1/5: Weak/Theoretical</span>
                </div>
                <div class="mt-2 pt-2 border-t border-slate-300">
                    <div class="flex items-center gap-2 text-green-700 font-semibold">
                        <span class="w-2 h-2 rounded-full bg-green-600"></span> Positive Effect
                    </div>
                    <div class="flex items-center gap-2 text-red-700 font-semibold">
                        <span class="w-2 h-2 rounded-full bg-red-600"></span> Negative Effect
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        class SafetyApp {
            constructor() {
                // --- Initial Data ---
                this.nodes = [
                    { id: 'n1', type: 'tier5', label: 'Financial Incentives', x: 100, y: 80, evidence: 2, desc: 'Vol vs Value (Payment Trap)' },
                    { id: 'n2', type: 'tier5', label: 'Governance & Regs', x: 350, y: 80, evidence: 3, desc: 'Regulatory Cacophony' },
                    { id: 'n3', type: 'tier5', label: 'Measurement/Reputation', x: 600, y: 80, evidence: 2, desc: 'Market Signal' },
                    { id: 'n4', type: 'tier5', label: 'Legal Environment', x: 850, y: 80, evidence: 4, desc: 'Liability Freeze' },
                    { id: 'n5', type: 'tier4', label: 'Board of Directors', x: 200, y: 250, evidence: 4, desc: 'Risk Appetite' },
                    { id: 'n6', type: 'tier4', label: 'Exec Leadership', x: 450, y: 250, evidence: 3, desc: 'Translation Engine' },
                    { id: 'n7', type: 'tier4', label: 'Resource Allocation', x: 700, y: 250, evidence: 5, desc: 'Slack vs Efficiency' },
                    { id: 'n8', type: 'tier3', label: 'Safety Culture', x: 250, y: 400, evidence: 3, desc: 'Psychological Safety' },
                    { id: 'n9', type: 'tier3', label: 'Physical Env & Staffing', x: 500, y: 400, evidence: 5, desc: 'Crowding/Ratios' },
                    { id: 'n10', type: 'tier3', label: 'Human-System Interface', x: 750, y: 400, evidence: 4, desc: 'Tech/Usability' },
                    { id: 'n11', type: 'tier2', label: 'Complexity vs Capacity', x: 500, y: 550, evidence: 0, desc: 'Friction Point' },
                    { id: 'n12', type: 'tier1', label: 'Cognitive Load', x: 400, y: 700, evidence: 5, desc: 'Fatigue/Burnout' },
                    { id: 'n13', type: 'tier1', label: 'The Patient', x: 650, y: 700, evidence: 0, desc: 'Keystone' }
                ];

                this.links = [
                    { id: 'l1', source: 'n1', target: 'n7', evidence: 5, type: 'neutral', label: 'Budget Constraints', desc: 'Slawomirski et al (2024)' },
                    { id: 'l2', source: 'n2', target: 'n6', evidence: 3, type: 'neutral', label: 'Mandates', desc: '' },
                    { id: 'l3', source: 'n4', target: 'n6', evidence: 4, type: 'negative', label: 'Fear of Liability', desc: 'Suppressing reporting' },
                    { id: 'l4', source: 'n5', target: 'n7', evidence: 4, type: 'positive', label: 'Approval', desc: '' },
                    { id: 'l5', source: 'n6', target: 'n7', evidence: 5, type: 'neutral', label: 'Strategy', desc: '' },
                    { id: 'l6', source: 'n6', target: 'n8', evidence: 3, type: 'positive', label: 'Modeling', desc: '' },
                    { id: 'l7', source: 'n7', target: 'n9', evidence: 5, type: 'neutral', label: 'FTE Counts', desc: 'Aiken et al.' },
                    { id: 'l8', source: 'n7', target: 'n10', evidence: 4, type: 'neutral', label: 'IT Budget', desc: '' },
                    { id: 'l9', source: 'n9', target: 'n11', evidence: 5, type: 'negative', label: 'Capacity Constraint', desc: '' },
                    { id: 'l10', source: 'n10', target: 'n11', evidence: 4, type: 'negative', label: 'Workflow Friction', desc: '' },
                    { id: 'l11', source: 'n11', target: 'n12', evidence: 5, type: 'negative', label: 'Overload', desc: '' },
                    { id: 'l12', source: 'n12', target: 'n13', evidence: 0, type: 'negative', label: 'Adverse Event', desc: '' }
                ];

                // --- State ---
                this.pan = { x: 0, y: 0 };
                this.isPanning = false;
                this.panStart = { x: 0, y: 0 };
                
                this.selection = null;
                this.draggingNodeId = null;
                this.dragOffset = { x: 0, y: 0 };

                this.isLinkingMode = false;
                this.tempLinkSourceId = null;
                this.mousePos = { x: 0, y: 0 };

                // --- Configuration ---
                this.TIER_STYLES = {
                    tier5: { bg: 'bg-slate-100', border: 'border-slate-400', text: 'text-slate-800', badge: 'bg-slate-600' },
                    tier4: { bg: 'bg-blue-50', border: 'border-blue-400', text: 'text-blue-800', badge: 'bg-blue-600' },
                    tier3: { bg: 'bg-orange-50', border: 'border-orange-400', text: 'text-orange-800', badge: 'bg-orange-600' },
                    tier2: { bg: 'bg-yellow-50', border: 'border-yellow-400', text: 'text-yellow-800', badge: 'bg-yellow-600' },
                    tier1: { bg: 'bg-red-50', border: 'border-red-400', text: 'text-red-800', badge: 'bg-red-600' }
                };

                // --- DOM Elements ---
                this.elPanLayer = document.getElementById('pan-layer');
                this.elSvgLayer = document.getElementById('svg-layer');
                this.elNodesLayer = document.getElementById('nodes-layer');
                this.elCanvasContainer = document.getElementById('canvas-container');
                this.elPropPanel = document.getElementById('properties-panel');
                this.elPropContent = document.getElementById('prop-content');
                this.elPropTitle = document.getElementById('prop-title');
                this.elBtnLinkMode = document.getElementById('btn-link-mode');

                this.init();
            }

            init() {
                this.renderAll();
                this.setupEventListeners();
            }

            // --- Rendering ---
            
            renderAll() {
                this.renderNodes();
                this.renderLinks();
                this.updatePanZoom();
                this.renderProperties();
                this.updateUIButtons();
            }

            renderNodes() {
                this.elNodesLayer.innerHTML = '';
                this.nodes.forEach(node => {
                    const styles = this.TIER_STYLES[node.type] || this.TIER_STYLES.tier3;
                    const isSelected = this.selection && this.selection.id === node.id;
                    const isSource = this.tempLinkSourceId === node.id;
                    
                    const div = document.createElement('div');
                    div.className = `absolute w-52 rounded-lg border-2 p-3 flex flex-col gap-1 pointer-events-auto cursor-grab active:cursor-grabbing node-base group
                        ${styles.bg} ${styles.border} ${isSelected || isSource ? 'node-selected' : 'shadow-md hover:shadow-lg z-10'}`;
                    div.style.left = `${node.x}px`;
                    div.style.top = `${node.y}px`;
                    div.dataset.id = node.id;
                    
                    // Stars HTML
                    let starsHtml = '';
                    for(let i=1; i<=5; i++) {
                        starsHtml += `<div class="w-1.5 h-1.5 rounded-full ${i <= node.evidence ? 'bg-yellow-500' : 'bg-gray-200'}"></div>`;
                    }

                    div.innerHTML = `
                        <div class="flex justify-between items-start pointer-events-none">
                            <span class="text-[10px] font-bold uppercase tracking-wider px-1.5 py-0.5 rounded text-white ${styles.badge}">
                                ${node.type}
                            </span>
                            <div class="flex gap-0.5">${starsHtml}</div>
                        </div>
                        <div class="font-bold leading-tight ${styles.text} pointer-events-none select-none">${node.label}</div>
                        ${node.desc ? `<div class="text-xs text-slate-500 italic mt-1 border-t border-slate-200/50 pt-1 pointer-events-none select-none">${node.desc}</div>` : ''}
                    `;

                    // Mouse Events on Node
                    div.addEventListener('mousedown', (e) => this.handleNodeMouseDown(e, node.id));
                    
                    this.elNodesLayer.appendChild(div);
                });
            }

            renderLinks() {
                const defs = this.elSvgLayer.querySelector('defs').outerHTML;
                let svgContent = defs;

                // Group links by their node pairs to handle multiple links
                const linkGroups = {};
                this.links.forEach(link => {
                    const key = [link.source, link.target].sort().join('-');
                    if (!linkGroups[key]) linkGroups[key] = [];
                    linkGroups[key].push(link);
                });

                this.links.forEach(link => {
                    const key = [link.source, link.target].sort().join('-');
                    const group = linkGroups[key];
                    const index = group.indexOf(link);
                    const total = group.length;

                    const isSelected = this.selection && this.selection.id === link.id;
                    const strokeWidth = Math.max(2, link.evidence);
                    
                    let strokeColor = '#94a3b8'; // Neutral
                    let markerId = 'arrowhead-neutral';
                    
                    if (isSelected) {
                        strokeColor = '#2563eb';
                        markerId = 'arrowhead-selected';
                    } else if (link.type === 'positive') {
                        strokeColor = '#16a34a';
                        markerId = 'arrowhead-positive';
                    } else if (link.type === 'negative') {
                        strokeColor = '#dc2626';
                        markerId = 'arrowhead-negative';
                    }

                    // Calculate Path with Arc if multiple
                    const pathD = this.getLinkPath(link.source, link.target, index, total);
                    const mid = this.getLinkMidpoint(link.source, link.target, index, total);
                    
                    // 1. Invisible Hitbox (Thick)
                    svgContent += `<path d="${pathD}" data-link-id="${link.id}" stroke="transparent" stroke-width="20" fill="none" class="cursor-pointer pointer-events-auto" />`;
                    
                    // 2. Visible Line
                    svgContent += `<path d="${pathD}" stroke="${strokeColor}" stroke-width="${strokeWidth}" fill="none" marker-end="url(#${markerId})" class="pointer-events-none transition-all duration-300" />`;
                    
                    // 3. Label Badge
                    svgContent += `
                        <foreignObject x="${mid.x - 50}" y="${mid.y - 12}" width="100" height="24" class="pointer-events-none overflow-visible">
                            <div data-link-id="${link.id}" class="pointer-events-auto cursor-pointer flex justify-center">
                                <span class="text-xs text-center truncate px-1 rounded border shadow-sm ${isSelected ? 'bg-blue-100 border-blue-300' : 'bg-white border-slate-200'} text-slate-600 max-w-[100px] hover:bg-slate-50 transition-colors">
                                    ${link.label}
                                </span>
                            </div>
                        </foreignObject>
                    `;
                });

                // Temporary Link Line (Linking Mode)
                if (this.isLinkingMode && this.tempLinkSourceId) {
                    const start = this.getNodeCenter(this.tempLinkSourceId);
                    const end = { x: this.mousePos.x - this.pan.x, y: this.mousePos.y - this.pan.y };
                    const pathD = `M ${start.x} ${start.y} L ${end.x} ${end.y}`;
                    svgContent += `<path d="${pathD}" stroke="#3b82f6" stroke-width="2" stroke-dasharray="5,5" fill="none" />`;
                }

                this.elSvgLayer.innerHTML = svgContent;
            }

            renderProperties() {
                if (!this.selection) {
                    this.elPropPanel.classList.add('hidden');
                    return;
                }
                this.elPropPanel.classList.remove('hidden');

                if (this.selection.type === 'node') {
                    const node = this.nodes.find(n => n.id === this.selection.id);
                    if (!node) return;
                    
                    // --- 1. Node Properties ---
                    let html = `
                        <div class="mb-6">
                            <div>
                                <label class="text-xs font-semibold text-slate-500 uppercase">Title</label>
                                <input type="text" value="${node.label}" oninput="window.app.updateNodeProp('label', this.value)" class="w-full mt-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div class="mt-3">
                                <label class="text-xs font-semibold text-slate-500 uppercase">Description</label>
                                <textarea oninput="window.app.updateNodeProp('desc', this.value)" class="w-full mt-1 px-3 py-2 border rounded text-sm h-16 focus:ring-2 focus:ring-blue-500 outline-none">${node.desc || ''}</textarea>
                            </div>
                            <div class="mt-3">
                                <label class="text-xs font-semibold text-slate-500 uppercase">Tier</label>
                                <select onchange="window.app.updateNodeProp('type', this.value)" class="w-full mt-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="tier5" ${node.type === 'tier5' ? 'selected' : ''}>Tier 5: External Env</option>
                                    <option value="tier4" ${node.type === 'tier4' ? 'selected' : ''}>Tier 4: Management</option>
                                    <option value="tier3" ${node.type === 'tier3' ? 'selected' : ''}>Tier 3: Latent Env</option>
                                    <option value="tier2" ${node.type === 'tier2' ? 'selected' : ''}>Tier 2: Nature of Work</option>
                                    <option value="tier1" ${node.type === 'tier1' ? 'selected' : ''}>Tier 1: Human Operator</option>
                                </select>
                            </div>
                            <div class="mt-3">
                                <label class="text-xs font-semibold text-slate-500 uppercase flex justify-between">
                                    Evidence Strength <span class="text-blue-600">${node.evidence}/5</span>
                                </label>
                                <input type="range" min="0" max="5" step="1" value="${node.evidence}" oninput="window.app.updateNodeProp('evidence', parseInt(this.value))" class="w-full mt-2 accent-blue-600">
                            </div>
                        </div>
                        
                        <div class="border-t border-slate-200 pt-4 mb-4">
                            <button onclick="window.app.deleteSelected()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-600 rounded hover:bg-red-100 transition-colors text-sm font-semibold">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                Delete Node
                            </button>
                        </div>
                    `;

                    // --- 2. Outgoing Links Section ---
                    const outgoingLinks = this.links.filter(l => l.source === node.id);
                    
                    if (outgoingLinks.length > 0) {
                        html += `<div class="border-t border-slate-200 pt-4">
                                    <h3 class="font-bold text-sm text-slate-700 mb-3 flex items-center gap-2">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="7" y1="17" x2="17" y2="7"/><polyline points="7 7 17 7 17 17"/></svg>
                                        Outgoing Connections
                                    </h3>
                                    <div class="flex flex-col gap-3">`;
                        
                        outgoingLinks.forEach(link => {
                            const targetNode = this.nodes.find(n => n.id === link.target);
                            const targetName = targetNode ? targetNode.label : 'Unknown';
                            
                            html += `
                                <div class="bg-slate-50 rounded border border-slate-200 p-3 shadow-sm">
                                    <div class="flex justify-between items-center mb-2 border-b border-slate-200 pb-2">
                                        <span class="text-xs font-bold text-blue-700 flex items-center gap-1">
                                            To: ${targetName}
                                        </span>
                                        <button onclick="window.app.deleteLink('${link.id}')" class="text-slate-400 hover:text-red-500" title="Delete Connection">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                        </button>
                                    </div>
                                    
                                    <div class="grid gap-2">
                                        <div>
                                            <label class="text-[10px] font-semibold text-slate-500 uppercase">Label</label>
                                            <input type="text" value="${link.label}" oninput="window.app.updateSpecificLink('${link.id}', 'label', this.value)" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 outline-none">
                                        </div>
                                        
                                        <div class="flex gap-2">
                                            <div class="flex-1">
                                                <label class="text-[10px] font-semibold text-slate-500 uppercase">Type</label>
                                                <select onchange="window.app.updateSpecificLink('${link.id}', 'type', this.value)" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 outline-none">
                                                    <option value="neutral" ${link.type === 'neutral' ? 'selected' : ''}>Neutral</option>
                                                    <option value="positive" ${link.type === 'positive' ? 'selected' : ''}>Positive</option>
                                                    <option value="negative" ${link.type === 'negative' ? 'selected' : ''}>Negative</option>
                                                </select>
                                            </div>
                                            <div class="flex-1">
                                                <label class="text-[10px] font-semibold text-slate-500 uppercase">Strength</label>
                                                <input type="number" min="1" max="5" value="${link.evidence}" oninput="window.app.updateSpecificLink('${link.id}', 'evidence', parseInt(this.value))" class="w-full px-2 py-1 text-xs border rounded focus:ring-1 focus:ring-blue-500 outline-none">
                                            </div>
                                        </div>

                                        <div>
                                            <label class="text-[10px] font-semibold text-slate-500 uppercase">Description / Evidence</label>
                                            <textarea oninput="window.app.updateSpecificLink('${link.id}', 'desc', this.value)" class="w-full px-2 py-1 text-xs border rounded h-12 focus:ring-1 focus:ring-blue-500 outline-none placeholder-slate-300" placeholder="Cite evidence...">${link.desc || ''}</textarea>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `</div></div>`;
                    } else {
                        html += `<div class="border-t border-slate-200 pt-4">
                                    <p class="text-xs text-slate-400 italic">No outgoing connections from this node.</p>
                                 </div>`;
                    }

                    this.elPropTitle.innerText = 'Edit Concept';
                    this.elPropContent.innerHTML = html;

                } else if (this.selection.type === 'link') {
                    // Fallback for direct link selection (still supported)
                    const link = this.links.find(l => l.id === this.selection.id);
                    if (!link) return;
                    
                    const sourceNode = this.nodes.find(n => n.id === link.source);
                    const targetNode = this.nodes.find(n => n.id === link.target);

                    this.elPropTitle.innerText = 'Edit Connection';
                    this.elPropContent.innerHTML = `
                         <div class="bg-blue-50 p-3 rounded mb-4 text-xs text-blue-800 border border-blue-200">
                            <strong>${sourceNode ? sourceNode.label : 'Src'}</strong> â†’ <strong>${targetNode ? targetNode.label : 'Tgt'}</strong>
                         </div>
                         <div>
                            <label class="text-xs font-semibold text-slate-500 uppercase">Link Label</label>
                            <input type="text" value="${link.label}" oninput="window.app.updateLinkProp('label', this.value)" class="w-full mt-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div class="mt-3">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Relationship Type</label>
                            <select onchange="window.app.updateLinkProp('type', this.value)" class="w-full mt-1 px-3 py-2 border rounded text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="neutral" ${link.type === 'neutral' ? 'selected' : ''}>Neutral (Gray)</option>
                                <option value="positive" ${link.type === 'positive' ? 'selected' : ''}>Positive/Reinforcing (Green)</option>
                                <option value="negative" ${link.type === 'negative' ? 'selected' : ''}>Negative/Inhibitory (Red)</option>
                            </select>
                        </div>
                        <div class="mt-3">
                            <label class="text-xs font-semibold text-slate-500 uppercase">Description / Citation</label>
                            <textarea oninput="window.app.updateLinkProp('desc', this.value)" placeholder="Source of evidence..." class="w-full mt-1 px-3 py-2 border rounded text-sm h-16 focus:ring-2 focus:ring-blue-500 outline-none">${link.desc || ''}</textarea>
                        </div>
                        <div class="mt-3">
                            <label class="text-xs font-semibold text-slate-500 uppercase flex justify-between">
                                Connection Strength <span class="text-blue-600">${link.evidence}/5</span>
                            </label>
                            <input type="range" min="1" max="5" step="1" value="${link.evidence}" oninput="window.app.updateLinkProp('evidence', parseInt(this.value))" class="w-full mt-2 accent-blue-600">
                            <p class="text-[10px] text-slate-400 mt-1">Controls line thickness</p>
                        </div>
                        <div class="mt-6 border-t border-slate-200 pt-4">
                            <button onclick="window.app.deleteSelected()" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-50 text-red-600 rounded hover:bg-red-100 transition-colors text-sm font-semibold">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                                Delete Connection
                            </button>
                        </div>
                    `;
                }
            }

            updateUIButtons() {
                if (this.isLinkingMode) {
                    this.elBtnLinkMode.classList.add('bg-blue-100', 'text-blue-700', 'shadow-inner');
                    this.elBtnLinkMode.classList.remove('hover:bg-white');
                    this.elBtnLinkMode.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Linking...`;
                } else {
                    this.elBtnLinkMode.classList.remove('bg-blue-100', 'text-blue-700', 'shadow-inner');
                    this.elBtnLinkMode.classList.add('hover:bg-white');
                    this.elBtnLinkMode.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg> Link Nodes`;
                }
            }

            updatePanZoom() {
                this.elPanLayer.style.transform = `translate(${this.pan.x}px, ${this.pan.y}px)`;
            }

            // --- Logic & Events ---

            setupEventListeners() {
                this.elCanvasContainer.addEventListener('click', (e) => {
                    const linkTarget = e.target.closest('[data-link-id]');
                    if (linkTarget) {
                        e.stopPropagation();
                        this.selectLink(e, linkTarget.dataset.linkId);
                        return;
                    }
                });

                this.elCanvasContainer.addEventListener('mousedown', (e) => {
                    const isLink = e.target.closest('[data-link-id]');
                    const isNode = e.target.closest('.node-base');
                    
                    if (!isLink && !isNode) {
                        this.isPanning = true;
                        this.panStart = { x: e.clientX - this.pan.x, y: e.clientY - this.pan.y };
                        this.deselectAll();
                    }
                });

                window.addEventListener('mousemove', (e) => {
                    this.mousePos = { x: e.clientX, y: e.clientY };

                    if (this.isPanning) {
                        this.pan = { x: e.clientX - this.panStart.x, y: e.clientY - this.panStart.y };
                        this.updatePanZoom();
                    } else if (this.draggingNodeId) {
                        const node = this.nodes.find(n => n.id === this.draggingNodeId);
                        if (node) {
                            node.x = (e.clientX - this.pan.x) - this.dragOffset.x;
                            node.y = (e.clientY - this.pan.y) - this.dragOffset.y;
                            this.renderNodes();
                            this.renderLinks();
                        }
                    } else if (this.isLinkingMode && this.tempLinkSourceId) {
                        this.renderLinks(); 
                    }
                });

                window.addEventListener('mouseup', () => {
                    this.isPanning = false;
                    this.draggingNodeId = null;
                });
            }

            handleNodeMouseDown(e, nodeId) {
                e.stopPropagation(); 
                
                if (this.isLinkingMode) {
                    if (!this.tempLinkSourceId) {
                        this.tempLinkSourceId = nodeId;
                        this.renderNodes();
                    } else {
                        this.addLink(this.tempLinkSourceId, nodeId);
                        this.tempLinkSourceId = null;
                        this.isLinkingMode = false;
                        this.renderAll();
                    }
                } else {
                    this.selection = { type: 'node', id: nodeId };
                    this.draggingNodeId = nodeId;
                    
                    const node = this.nodes.find(n => n.id === nodeId);
                    this.dragOffset = { 
                        x: (e.clientX - this.pan.x) - node.x, 
                        y: (e.clientY - this.pan.y) - node.y 
                    };
                    
                    this.renderAll();
                }
            }

            selectLink(e, linkId) {
                this.selection = { type: 'link', id: linkId };
                this.renderAll();
            }

            deselectAll() {
                this.selection = null;
                this.renderAll();
            }

            toggleLinkMode() {
                this.isLinkingMode = !this.isLinkingMode;
                this.tempLinkSourceId = null;
                this.renderAll();
            }

            addNode() {
                const id = `n_${Date.now()}`;
                const newNode = {
                    id,
                    type: 'tier3',
                    label: 'New Concept',
                    x: -this.pan.x + 100,
                    y: -this.pan.y + 100,
                    evidence: 0,
                    desc: 'Description'
                };
                this.nodes.push(newNode);
                this.selection = { type: 'node', id };
                this.renderAll();
            }

            addLink(sourceId, targetId) {
                if (sourceId === targetId) return; 

                const newLink = {
                    id: `l_${Date.now()}`,
                    source: sourceId,
                    target: targetId,
                    label: 'New Link',
                    type: 'neutral',
                    evidence: 2,
                    desc: ''
                };
                this.links.push(newLink);
                this.selection = { type: 'link', id: newLink.id };
            }

            deleteSelected() {
                if (!this.selection) return;
                
                if (this.selection.type === 'node') {
                    const id = this.selection.id;
                    this.nodes = this.nodes.filter(n => n.id !== id);
                    this.links = this.links.filter(l => l.source !== id && l.target !== id);
                } else {
                    this.links = this.links.filter(l => l.id !== this.selection.id);
                }
                this.selection = null;
                this.renderAll();
            }
            
            deleteLink(linkId) {
                this.links = this.links.filter(l => l.id !== linkId);
                // If the deleted link was currently selected in the main selection state, clear it
                if (this.selection && this.selection.type === 'link' && this.selection.id === linkId) {
                    this.selection = null;
                }
                this.renderAll();
            }

            // --- Property Updates ---
            updateNodeProp(prop, value) {
                if (this.selection && this.selection.type === 'node') {
                    const node = this.nodes.find(n => n.id === this.selection.id);
                    if (node) {
                        node[prop] = value;
                        this.renderNodes();
                        this.renderProperties();
                    }
                }
            }

            updateLinkProp(prop, value) {
                if (this.selection && this.selection.type === 'link') {
                    const link = this.links.find(l => l.id === this.selection.id);
                    if (link) {
                        link[prop] = value;
                        this.renderLinks();
                        this.renderProperties();
                    }
                }
            }
            
            updateSpecificLink(linkId, prop, value) {
                const link = this.links.find(l => l.id === linkId);
                if (link) {
                    link[prop] = value;
                    this.renderLinks();
                    // Don't re-render entire properties here to avoid losing focus on input
                }
            }

            exportData() {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ nodes: this.nodes, links: this.links }));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "safety_map.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            // --- IMPORT FUNCTION ---
            importData(inputElement) {
                const file = inputElement.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (data.nodes && data.links) {
                            this.nodes = data.nodes;
                            this.links = data.links;
                            this.deselectAll(); 
                            this.renderAll();
                            alert('Import successful!');
                        } else {
                            alert('Invalid file format. JSON must contain nodes and links arrays.');
                        }
                    } catch (err) {
                        console.error(err);
                        alert('Error parsing JSON file.');
                    }
                    // Reset input so same file can be selected again
                    inputElement.value = '';
                };
                reader.readAsText(file);
            }

            // --- Helpers ---
            getNodeCenter(nodeId) {
                const node = this.nodes.find(n => n.id === nodeId);
                if (!node) return { x: 0, y: 0 };
                return { x: node.x + 104, y: node.y + 40 };
            }

            getLinkPath(sourceId, targetId, index, total) {
                const start = this.getNodeCenter(sourceId);
                const end = this.getNodeCenter(targetId);
                
                const dx = end.x - start.x;
                const dy = end.y - start.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                let offset = 0;
                if (total > 1) {
                    const spread = 60; 
                    offset = (index - (total - 1) / 2) * spread;
                }

                const nx = -dy / dist;
                const ny = dx / dist;

                const mx = (start.x + end.x) / 2 + nx * offset;
                const my = (start.y + end.y) / 2 + ny * offset;

                return `M ${start.x} ${start.y} Q ${mx} ${my} ${end.x} ${end.y}`;
            }

            getLinkMidpoint(sourceId, targetId, index, total) {
                const start = this.getNodeCenter(sourceId);
                const end = this.getNodeCenter(targetId);
                const dx = end.x - start.x;
                const dy = end.y - start.y;
                const dist = Math.sqrt(dx*dx + dy*dy);

                let offset = 0;
                if (total > 1) {
                    const spread = 60; 
                    offset = (index - (total - 1) / 2) * spread;
                }

                const nx = -dy / dist;
                const ny = dx / dist;
                
                const cx = (start.x + end.x) / 2 + nx * offset;
                const cy = (start.y + end.y) / 2 + ny * offset;

                const midX = 0.25 * start.x + 0.5 * cx + 0.25 * end.x;
                const midY = 0.25 * start.y + 0.5 * cy + 0.25 * end.y;

                return { x: midX, y: midY };
            }
        }

        window.app = new SafetyApp();
    </script>
</body>
</html>
